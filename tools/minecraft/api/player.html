<!DOCTYPE html>
<html>
<head>
    <style data-name="Page styles">
        output img {width: 256px; image-rendering: pixelated;}
    </style>
</head>
<body onload="getInfo();">
    <script data-name="Page scripts">

        function error(err) {
            if (err === "PlayerNotFoundError") {
                $('#username_uuid').empty();
                $('#username-history').html("Could not find player");
                $('#skin').empty();
            } else if (err === "SkinNotFoundError") {
                $('#skin').empty();
            } else {
                $('output').html("Unknown error")
            }
        }
        
        var query = location.href.split('?')[1];
        $('#input-username').val(query);
        $(function() {getInfo(query);});

        var skinURLs = {}, capeURLs = {};
        function getInfo(username) {
            if (!username && query) username = query;
            $('#username-history').empty();
            $('#username_uuid').html('Loading...');
            $('#skin').empty();
            $.ajax({
                url: 'https://cors-anywhere.herokuapp.com/https://api.mojang.com/users/profiles/minecraft/' + username
            }).done(function(data) {
                if (!data) error("PlayerNotFoundError");
                var username;
                var uuid;
                if (data) uuid = data.id;
                var uuidFormatted = [
                    uuid.substring(0,8),
                    uuid.substring(8,12), uuid.substring(12,17), uuid.substring(17,21),
                    uuid.substring(21,32)
                ].join('-');
                $.ajax({
                    url: `https://cors-anywhere.herokuapp.com/https://api.mojang.com/user/profiles/${uuid}/names`
                }).done(function(data) {
                    $('#username-history').empty();
                    username = data[data.length-1].name;
                    $('#username_uuid').html(`<strong style="font-size: 1.5em;">${username} (UUID ${uuidFormatted})</strong>`);
                    for (i in data) {
                        let name = data[i].name;
                        let date = moment(data[i].changedToAt).format('DD MMM YYYY [at] HH:mm:ss [UTC]');
                        if (i == 0 && data.length == 1) {
                            $('#username-history').append(`<li>Current name: ${name}</li>`);
                        } else if (i == data.length-1) {
                            $('#username-history').append(`<li>Name #${parseInt(i)+1} (current): ${name}<br class="mobileonly"/>(changed on ${date})</li>`);
                        } else if (i == 0) {
                            $('#username-history').append(`<li>Name #1: ${name}</li>`);
                        } else {
                            $('#username-history').append(`<li>Name #${parseInt(i)+1}: ${name}<br class="mobileonly"/>(changed on ${date})</li>`);
                        }
                    }
                    $.ajax({
                        url: 'https://cors-anywhere.herokuapp.com/https://sessionserver.mojang.com/session/minecraft/profile/' + uuid
                    }).done(function(data) {
                        let encoded_data = data.properties[0].value;
                        let decoded_data = JSON.parse(atob(encoded_data));
                        let skinURL = decoded_data.textures.SKIN.url.replace('http:','https:');
                        if (username) skinURLs[username] = skinURL;
                        $('#skin').html(`
                            <img src="${skinURL}" alt="${username}'s skin">
                        `);
                        if (cape = decoded_data.textures.CAPE) {
                            capeURL = cape.url.replace('http:','https:');
                            if (username) capeURLs[username] = capeURL;
                            $('#skin').append(`
                                <img src="${capeURL}" alt="${username}'s cape">
                            `);
                        }
                    }).fail(function(data, textStatus, error) {
                        if (skinURLs[username] || capeURLs[username]) {
                            $('#skin').append(`
                                <img src="${skinURLs[username]}" alt="${username}'s skin">
                            `);
                            if (capeURLs[username]) {
                                $('#skin').append(`
                                    <img src="${capeURLs[username]}" alt="${username}'s cape">
                                `);
                            }
                        } else {
                            error("SkinNotFoundError");
                        }
                    });
                }).fail(function() {
                    error("PlayerNotFoundError");
                });
            }).fail(function() {
                error("PlayerNotFoundError");
            });
        }
    </script>
    <script id="page-loader-script">
        var PAGE_DATA = {
            title: "Minecraft Player API",
            description: "Get information about Minecraft player, including UUID, username history, skins, and capes.",
            keywords: "nixinova,minecraft,minecraft api,minecraft player info,minecraft player api,minecraft player lookup",
            stylesheets: ["tools.css"],
            scripts: [],
            footer_classes: []
        }
        $(document).ready(function() {loadData(PAGE_DATA);});
    </script>

    <template id="page-loader-content">
        <h1>Minecraft Player API</h1>
        <p style="text-align: center;">Get information about any Minecraft player.</p>
        <div>
            <p style="text-align: center;">
                <label>Username:</label>
                <input type="text" id="input-username"> &nbsp;
                <button id="get-info" onclick="getInfo($('#input-username').val());">Get info</button><br>
            </p>
        </div>
        <output>
            <p id="username_uuid"></p>
            <ul id="username-history"></ul>
            <div id="skin" style="text-align: center;"></div>
        </output>
    </template>
</body>
</html>
